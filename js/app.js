define(["components/react","components/react-dom","components/lodash","components/moment","components/cldr/en","components/cldr/core","components/jsspeechrecognizer","components/chrono"],function(e,t,n,r,i,o,s,a){"use strict";function c(e){this.message=`The response returned a ${e} HTTP status code.`,this.statusCode=e,this.name="HttpError",Error.call(this)}e="default"in e?e.default:e,t="default"in t?t.default:t,n="default"in n?n.default:n,r="default"in r?r.default:r,s="default"in s?s.default:s,a="default"in a?a.default:a;var l=function(){var e="function"==typeof Symbol&&Symbol.for&&Symbol.for("react.element")||60103;return function(t,n,r,i){var o=t&&t.defaultProps,s=arguments.length-3;if(n||0===s||(n={}),n&&o)for(var a in o)void 0===n[a]&&(n[a]=o[a]);else n||(n=o||{});if(1===s)n.children=i;else if(s>1){for(var c=Array(s),l=0;l<s;l++)c[l]=arguments[l+3];n.children=c}return{$$typeof:e,type:t,key:void 0===r?null:""+r,ref:null,props:n,_owner:null}}}(),u=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},h=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),p=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},f=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},d=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)},g=function(){function e(t){u(this,e),Object.assign(this,t||{})}return e.prototype.main=function(){throw new Error("Not implemented!")},e}(),m=function(e){function t(n){u(this,t);var r=f(this,e.call(this,n));return r.state={login:"mozilla"},r.server=n.server,r.onChange=r.onChange.bind(r),r.onFormSubmit=r.onFormSubmit.bind(r),r}return p(t,e),t.prototype.onChange=function(e){var t=e.target.value;this.setState({login:t})},t.prototype.onFormSubmit=function(e){e.preventDefault(),this.server.login(this.state.login,"password").then(function(){location.hash="reminders"})},t.prototype.render=function(){return l("form",{className:"user-login",onSubmit:this.onFormSubmit},void 0,l("input",{value:this.state.login,placeholder:"Family name",className:"user-login__name-field",onChange:this.onChange}),l("button",{className:"user-login__login-button"},void 0,l("img",{src:"css/icons/next.svg"})))},t}(e.Component),y=["login","logout"],v=y[0],b=function(n){function r(){return u(this,r),f(this,n.apply(this,arguments))}return p(r,n),r.prototype.main=function(){var e=arguments.length<=0||void 0===arguments[0]?v:arguments[0];switch(y.includes(e)||(console.error(`Bad users route: "${e}". Falling back to ${v}.`),e=v),e){case"login":this.login();break;case"logout":this.logout()}},r.prototype.login=function(){t.render(e.createElement(m,{server:this.server}),this.mountNode)},r.prototype.logout=function(){this.server.logout().then(function(){location.hash="users/login"})},r}(g),w=["red","orange","green","blue","violet"],S=function(e){function t(n){u(this,t);var r=f(this,e.call(this,n));return TwitterCldr.set_data(TwitterCldrDataBundle),r.listFormatter=new TwitterCldr.ListFormatter,r.reminder=n.reminder,r.onDelete=n.onDelete,r}return p(t,e),t.prototype.getColour=function(){var e=arguments.length<=0||void 0===arguments[0]?[]:arguments[0],t=e.join(" "),n=function(e){var t=0,n=void 0,r=void 0,i=void 0;if(0===e.length)return 0;for(n=0,i=e.length;n<i;n++)r=e.charCodeAt(n),t=(t<<5)-t+r,t|=0;return t};return w[n(t)%w.length]},t.prototype.render=function(){var e=this.reminder,t=["reminders__item-content",this.getColour(e.recipients)].join(" ");return l("li",{className:"reminders__item"},void 0,l("div",{className:"reminders__item-time"},void 0,l("div",{},void 0,r(e.datetime).format("LT"))),l("div",{className:t},void 0,l("h3",{className:"reminders__item-recipient"},void 0,this.listFormatter.format(e.recipients)),l("p",{className:"reminders__item-text"},void 0,e.content,l("button",{className:"reminders__delete",onClick:this.onDelete},void 0,"Delete"))))},t}(e.Component),k=function(e){function t(n){u(this,t);var i=f(this,e.call(this,n));return i.state={reminders:[]},i.speechController=n.speechController,i.server=n.server,i.refreshInterval=null,i.debugEvent=i.debugEvent.bind(i),i.onReminder=i.onReminder.bind(i),r.locale(navigator.languages||navigator.language||"en-US"),i}return p(t,e),t.prototype.componentDidMount=function(){var e=this;this.server.reminders.getAll().then(function(t){t=t.map(function(e){return{id:e.id,recipients:e.recipients,content:e.action,datetime:e.due}}),e.setState({reminders:t})}),this.refreshInterval=setInterval(function(){e.speechController.idle&&location.reload(!0)},3e5),this.speechController.on("wakelistenstart",this.debugEvent),this.speechController.on("wakelistenstop",this.debugEvent),this.speechController.on("wakeheard",this.debugEvent),this.speechController.on("speechrecognitionstart",this.debugEvent),this.speechController.on("speechrecognitionstop",this.debugEvent),this.speechController.on("reminder",this.debugEvent),this.speechController.on("reminder",this.onReminder)},t.prototype.componentWillUnmount=function(){clearInterval(this.refreshInterval),this.speechController.off("wakelistenstart",this.debugEvent),this.speechController.off("wakelistenstop",this.debugEvent),this.speechController.off("wakeheard",this.debugEvent),this.speechController.off("speechrecognitionstart",this.debugEvent),this.speechController.off("speechrecognitionstop",this.debugEvent),this.speechController.off("reminder",this.debugEvent),this.speechController.off("reminder",this.onReminder)},t.prototype.debugEvent=function(e){return void 0!==e.result?void console.log(e.type,e.result):void console.log(e.type)},t.prototype.onReminder=function(e){var t=this,n=e.result;this.server.reminders.set({recipients:n.users,action:n.action,due:Number(n.time)}).then(function(e){var r=t.state.reminders;r.push({id:e.id,recipients:e.recipients,content:e.action,datetime:e.due}),t.setState({reminders:r}),console.log("Voice confirmation:",n.confirmation),t.speechController.speak(n.confirmation)}).catch(function(e){console.error("Saving the reminder failed.",e)})},t.prototype.onDelete=function(e){var t=this;this.server.reminders.delete(e).then(function(){var n=t.state.reminders.filter(function(t){return t.id!==e});t.setState({reminders:n})}).catch(function(){console.error(`The reminder ${e} could not be deleted.`)})},t.prototype.render=function(){var e=this,t=this.state.reminders;t=t.sort(function(e,t){return e.datetime-t.datetime}),t=n.groupBy(t,function(e){return r(e.datetime).format("YYYY/MM")}),Object.keys(t).forEach(function(e){t[e]=n.groupBy(t[e],function(e){return r(e.datetime).format("YYYY/MM/DD")})});var i=Object.keys(t).map(function(n){var i=r(n,"YYYY/MM").format("MMMM"),o=t[n];return l("div",{},n,l("h2",{className:"reminders__month"},void 0,i),Object.keys(o).map(function(t){var n=r(t,"YYYY/MM/DD"),i=o[t];return l("div",{className:"reminders__day"},t,l("div",{className:"reminders__day-date"},void 0,l("div",{className:"reminders__day-mday"},void 0,n.format("DD")),l("div",{className:"reminders__day-wday"},void 0,n.format("ddd"))),l("ol",{className:"reminders__list"},void 0,i.map(function(t){return l(S,{reminder:t,onDelete:e.onDelete.bind(e,t.id)},t.id)})))}))});return l("section",{className:"reminders"},void 0,i)},t}(e.Component),E=function(e){function t(n){u(this,t);var r=f(this,e.call(this,n));return r.state={isListening:!1},r.speechController=n.speechController,r.server=n.server,r.bleep=new Audio,r.bleep.src="media/cue.wav",r.speechController.on("wakeheard",function(){r.bleep.pause(),r.bleep.currentTime=0,r.bleep.play(),r.setState({isListening:!0})}),r.speechController.on("speechrecognitionstop",function(){r.setState({isListening:!1})}),r.click=r.click.bind(r),r}return p(t,e),t.prototype.click=function(){return this.state.isListening?(this.bleep.pause(),this.setState({isListening:!1}),void this.speechController.stopSpeechRecognition()):(this.bleep.pause(),this.bleep.currentTime=0,this.bleep.play(),this.setState({isListening:!0}),void this.speechController.startSpeechRecognition())},t.prototype.render=function(){if(!this.server.isLoggedIn)return null;var e=this.state.isListening?"listening":"";return l("div",{className:e,onClick:this.click},void 0,l("div",{className:"microphone__background"}),l("img",{className:"microphone__icon",src:"css/icons/microphone.svg"}))},t}(e.Component),R=function(n){function r(){return u(this,r),f(this,n.apply(this,arguments))}return p(r,n),r.prototype.main=function(){t.render(e.createElement(k,{speechController:this.speechController,server:this.server}),this.mountNode),t.render(e.createElement(E,{speechController:this.speechController,server:this.server}),document.querySelector(".microphone"))},r}(g),C=function(e){if(!e||"string"!=typeof e)throw new Error("Event name should be a valid non-empty string!")},O=function(e){if("function"!=typeof e)throw new Error("Handler should be a function!")},L=function(e,t){if(e&&e.indexOf(t)<0)throw new Error(`Event "${t}" is not allowed!`)},j=Object.freeze({allowedEvents:Symbol("allowedEvents"),listeners:Symbol("listeners")}),T=function(){function e(t){if(u(this,e),"undefined"!=typeof t&&!Array.isArray(t))throw new Error("Allowed events should be a valid array of strings!");this[j.listeners]=new Map,this[j.allowedEvents]=t}return e.prototype.on=function(e,t){C(e),L(this[j.allowedEvents],e),O(t);var n=this[j.listeners].get(e);n||(n=new Set,this[j.listeners].set(e,n)),n.add(t)},e.prototype.once=function e(t,n){var r=this;O(n);var e=function(i){r.off(t,e),n.call(r,i)};this.on(t,e)},e.prototype.off=function(e,t){C(e),L(this[j.allowedEvents],e),O(t);var n=this[j.listeners].get(e);n&&(n.delete(t),n.size||this[j.listeners].delete(e))},e.prototype.offAll=function(e){if("undefined"==typeof e)return void this[j.listeners].clear();C(e),L(this[j.allowedEvents],e);var t=this[j.listeners].get(e);t&&(t.clear(),this[j.listeners].delete(e))},e.prototype.emit=function(e,t){var n=this;C(e),L(this[j.allowedEvents],e);var r=this[j.listeners].get(e);r&&r.forEach(function(e){try{e.call(n,t)}catch(e){console.error(e)}})},e.prototype.hasListeners=function(e){return C(e),L(this[j.allowedEvents],e),this[j.listeners].has(e)},e}(),P=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];u(this,e);var n=t.minimumConfidence||.35,r=t.bufferCount||80,i=t.maxVoiceActivityGap||300,o=t.numGroups||60,a=t.groupSize||5;this.recogniser=new s,this.recogniser.keywordSpottingMinimumConfidence=n,this.recogniser.keywordSpottingBufferCount=r,this.recogniser.keywordSpottingMaxVoiceActivityGap=i,this.recogniser.numGroups=o,this.recogniser.groupSize=a,Object.seal(this)}return e.prototype.startListening=function(){var e=this;return new Promise(function(t){e.recogniser.closeMic(),e.recogniser.openMic(),e.recogniser.isRecording()||e.recogniser.startKeywordSpottingRecording(),t()})},e.prototype.stopListening=function(){var e=this;return new Promise(function(t){e.recogniser.isRecording()&&e.recogniser.stopRecording(),e.recogniser.closeMic(),t()})},e.prototype.loadModel=function(e){if(this.recogniser.isRecording())throw new Error("Load the model data before listening for wakeword");this.recogniser.model=e},e.prototype.setOnKeywordSpottedCallback=function(e){this.recogniser.keywordSpottedCallback=e},e}(),M=Object.freeze({isListening:Symbol("isListening"),recognition:Symbol("recognition"),supportsRecognition:Symbol("supportsRecognition")}),N=function(){function e(){u(this,e),this[M.isListening]=!1;var t=window.SpeechRecognition||window.webkitSpeechRecognition,n=!!t;this[M.supportsRecognition]=n,n?(this[M.recognition]=new t,this[M.recognition].continuous=!0):this[M.recognition]=null,Object.seal(this)}return e.prototype.listenForUtterance=function(){var e=this;return this[M.supportsRecognition]?this[M.isListening]?Promise.reject(new Error("Speech recognition is already listening")):new Promise(function(t,n){e[M.isListening]=!0,e[M.recognition].onresult=function(n){if(e[M.isListening]){e[M.recognition].stop(),e[M.isListening]=!1;var r=n.results[0][0];return t({confidence:r.confidence,utterance:r.transcript})}},e[M.recognition].onerror=function(t){return e[M.recognition].stop(),e[M.isListening]=!1,n(t)},e[M.recognition].start()}):Promise.reject(new Error("Speech recognition not supported in this browser"))},e.prototype.abort=function(){return this[M.recognition].stop(),this[M.isListening]=!1,Promise.resolve()},e}(),U=Object.freeze({synthesis:Symbol("synthesis"),supportsSynthesis:Symbol("supportsSynthesis"),preferredVoice:Symbol("preferredVoice"),initialised:Symbol("initialised"),setPreferredVoice:Symbol("setPreferredVoice")}),_=.8,A=.9,F=function(){function e(){u(this,e);var t=window.speechSynthesis;this[U.initialised]=!1,this[U.supportsSynthesis]=!!t,this[U.preferredVoice]=null,this[U.supportsSynthesis]?(this[U.synthesis]=t,this[U.setPreferredVoice](),this[U.synthesis].onvoiceschanged=this[U.setPreferredVoice].bind(this)):this[U.synthesis]=null,Object.seal(this)}return e.prototype.speak=function(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0];if(e){var t=new SpeechSynthesisUtterance(e);this[U.preferredVoice]&&(t.voice=this[U.preferredVoice]),t.lang="en",t.pitch=_,t.rate=A,this[U.synthesis].speak(t)}},e.prototype[U.setPreferredVoice]=function(){if(!this[U.initialised]){var e=this[U.synthesis].getVoices();if(e.length){var t=e.filter(function(e){return"en"===e.lang||e.lang.startsWith("en-")}),n=t.filter(function(e){return e.name.includes("Female")});n.length?this[U.preferredVoice]=n[0]:t.length&&(this[U.preferredVoice]=t[0]),this[U.initialised]=!0,this[U.synthesis].onvoiceschanged=null}}},e}(),V=Object.freeze({listFormatter:Symbol("listFormatter"),getLocalised:Symbol("getLocalised"),formatUser:Symbol("formatUser"),formatAction:Symbol("formatAction"),formatTime:Symbol("formatTime"),isToday:Symbol("isToday"),isTomorrow:Symbol("isTomorrow"),isThisMonth:Symbol("isThisMonth"),formatHoursAndMinutes:Symbol("formatHoursAndMinutes")}),x="en",D={en:{template:`OK, I'll remind [users] [action] [time].`,formatUser:function(e){return e.replace(/\bme\b/gi,"you").replace(/\bI\b/gi,"you").replace(/\bmy\b/gi,"your").replace(/\bmine\b/gi,"yours")}},fr:{template:`OK, je rappelerai [users] [action] [time].`,formatUser:function(e){return e}},ja:{template:`承知しました。[time][users]に[action]をリマインドします。`,formatUser:function(e){return e}}},z=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?x:arguments[0];u(this,e),this.locale=t,TwitterCldr.set_data(TwitterCldrDataBundle),this[V.listFormatter]=new TwitterCldr.ListFormatter}return e.prototype.getReminderMessage=function(e){var t=this[V.getLocalised]("template"),n={users:this[V.formatUser](e),action:this[V.formatAction](e),time:this[V.formatTime](e)};return t.replace(/\[([^\]]+)\]/g,function(e,t){return n[t]})},e.prototype[V.getLocalised]=function(e){var t=this.locale;return D[this.locale]&&D[this.locale][e]||(t=x),D[t][e]},e.prototype[V.formatUser]=function(e){var t=this[V.getLocalised]("formatUser"),n=e.users.map(t);return this[V.listFormatter].format(n)},e.prototype[V.formatAction]=function(e){var t=this[V.getLocalised]("formatUser"),n=t(e.action),r=new RegExp(`\\bthat \\[action\\]`,"iu"),i=new RegExp(`\\bit is \\[action\\]`,"iu");return r.test(e.match)?`that ${n}`:i.test(e.match)?`that it is ${n}`:`to ${n}`},e.prototype[V.formatTime]=function(e){var t=e.time,n="";if(this[V.isToday](t)){var i=this[V.formatHoursAndMinutes](t);n=`at ${i} today`}else if(this[V.isTomorrow](t)){var o=this[V.formatHoursAndMinutes](t);n=`at ${o} tomorrow`}else n=this[V.isThisMonth](t)?r(t).format("[on the] Do"):r(t).format("[on] MMMM [the] Do");return n},e.prototype[V.isToday]=function(e){var t=r().startOf("day"),n=r().add(1,"day").startOf("day");return r(e).isBetween(t,n)},e.prototype[V.isTomorrow]=function(e){var t=r().add(1,"day").startOf("day"),n=r().add(2,"day").startOf("day");return r(e).isBetween(t,n)},e.prototype[V.isThisMonth]=function(e){var t=r().startOf("month"),n=r().add(1,"month").startOf("month");return r(e).isBetween(t,n)},e.prototype[V.formatHoursAndMinutes]=function(e){if(e=r(e),0===e.minute())return e.format("h A");if(15===e.minute())return e.format("[quarter past] h A");if(30===e.minute())return e.format("[half past] h A");if(45===e.minute()){var t=e.add(1,"hour");return t.format("[quarter to] h A")}return e.format("h m A")},e}(),W=new a.Parser;W.pattern=function(){return new RegExp("midnight|morning|in the morning|noon|afternoon|in the afternoon|evening|in the evening|night|at night","i")},W.extract=function(e,t,n){var r=void 0,i=void 0;switch(n[0].toLowerCase()){case"midnight":r=0,i=0;break;case"morning":case"in the morning":r=9,i=0;break;case"noon":r=12,i=1;break;case"afternoon":case"in the afternoon":r=15,i=1;break;case"evening":case"in the evening":r=19,i=1;break;case"night":case"at night":r=10,i=1}return new a.ParsedResult({ref:t,text:n[0],index:n.index,start:{hour:r,meridiem:i}})};var I=new a.Refiner;I.refine=function(e,t){function n(e,t){!e.isCertain("meridiem")&&e.get("year")===t.getFullYear()&&e.get("month")===t.getMonth()+1&&e.get("day")===t.getDate()&&e.get("hour")<t.getHours()&&(e.assign("meridiem",1),e.assign("hour",e.get("hour")+12))}var r=arguments.length<=2||void 0===arguments[2]?{}:arguments[2];return r.forwardHoursOnly!==!0?t:(t.forEach(function(e){n(e.start,e.ref),e.end&&n(e.end,e.ref)}),t)};var Y=new a.Chrono(a.options.casualOption());Y.parsers.push(W),Y.refiners.push(I);var B={parse:function(e){return Y.parse(e,new Date,{forwardDatesOnly:!0,forwardHoursOnly:!0})}},H=Object.freeze({confirmation:Symbol("confirmation"),patterns:Symbol("patterns"),parseUsers:Symbol("parseUsers"),parseAction:Symbol("parseAction"),parseDatetime:Symbol("parseDatetime"),normalise:Symbol("normalise"),init:Symbol("init"),buildPatterns:Symbol("buildPatterns"),splitOnPlaceholders:Symbol("splitOnPlaceholders"),escape:Symbol("escape")}),G={en:{patterns:[`Remind [users] to [action] at [time].`,`Remind [users] to [action] on [time].`,`Remind [users] to [action] by [time].`,`Remind [users] at [time] to [action].`,`Remind [users] on [time] to [action].`,`Remind [users] by [time] to [action].`,`Remind [users] to [action].`,`Remind [users] that it is [action] on [time].`,`Remind [users] that it is [action] at [time].`,`Remind [users] that it is [action] by [time].`,`Remind [users] that it is [action].`,`Remind [users] that [action] at [time].`,`Remind [users] that [action] on [time].`,`Remind [users] that [action] by [time].`,`Remind [users] that [action].`,`Remind [users] that [time] is [action].`],placeholders:{users:"( \\S+ | \\S+,? and \\S+ )",action:"(.+)",time:"(.+)"},punctuation:new RegExp(`[-‐–—,;:!?.…'‘’"“”()\\[\\]§@*/&#†‡′″]+$`,"u"),listBreaker:new RegExp(`,|, and\\b|\\band\\b`,"gu")},fr:{patterns:[`Rappelle [users] de [action] [time].`,`Rappelle [users] d'[action] [time].`,`Rappelle-[users] de [action] [time].`,`Rappelle-[users] d'[action] [time].`],placeholders:{users:"( \\S+ | \\S+ et \\S+ )",action:"(.+)",time:"(.+)"},punctuation:new RegExp(`[-‐–—,;:!?.…’"“”«»()\\[\\]§@*/&#†‡]+$`,"u"),listBreaker:new RegExp(`,|\\bet\\b`,"gu")},ja:{patterns:[`[time][action]を[users]に思い出させて。`,`[time][users]に[action]を思い出させて。`,`[time][users]は[action]と言うリマインダーを作成して。`],placeholders:{users:"(\\S+|\\S+、\\S+)",action:"(.+)",time:"(.+)"},punctuation:new RegExp(`[-‾_＿－‐—―〜・･,，、､;；:：!！?？.．‥…。｡＇‘’"＂“”(（)）\\[［\\]］{｛}｝`+`〈〉《》「｢」｣『』【】〔〕‖§¶@＠*＊/／\＼&＆#＃%％‰†‡′″〃※]+$`,"u"),listBreaker:new RegExp(`、`,"gu")}},J=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?"en":arguments[0];u(this,e),this.locale=t,this[H.confirmation]=new z(t),this[H.patterns]={},this[H.init](),window.intentParser=this,Object.seal(this)}return e.prototype.parse=function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?"":arguments[0];return t?new Promise(function(n,r){t=e[H.normalise](t);var i=e[H.parseDatetime](t),o=i.time,s=i.processedPhrase;if(!o)return r("Time could not be parsed.");var a=e[H.patterns][e.locale].some(function(r){if(!r.regexp.test(s))return!1;var i=r.regexp.exec(s);i.shift();var a=e[H.parseUsers](i[r.placeholders.users],t),c=e[H.parseAction](i[r.placeholders.action],t),l=r.match,u=e[H.confirmation].getReminderMessage({users:a,action:c,time:o,match:l});return n({users:a,action:c,time:o,confirmation:u}),!0});return a?void 0:r("Unsupported intent format.")}):Promise.reject("Empty string.")},e.prototype[H.parseUsers]=function(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0];return e.split(G[this.locale].listBreaker).map(function(e){return e.trim()})},e.prototype[H.parseAction]=function(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0];return e.trim()},e.prototype[H.parseDatetime]=function(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0];e=e.trim();var t=B.parse(e);if(!t.length)return{time:null,processedPhrase:""};t.length>1&&console.error("More than 2 temporal components detected.");var n=t[0],r=n.start.date(),i=e.substr(0,n.index)+e.substr(n.index+n.text.length);return{time:r,processedPhrase:i}},e.prototype[H.normalise]=function(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0],t=arguments.length<=1||void 0===arguments[1]?this.locale:arguments[1];return e.replace(/\s+/g," ").trim().replace(G[t].punctuation,"")},e.prototype[H.init]=function(){var e=this;Object.keys(G).forEach(function(t){e[H.patterns][t]=G[t].patterns.map(function(n){return e[H.buildPatterns](t,n,G[t].placeholders)})})},e.prototype[H.buildPatterns]=function(){var e=arguments.length<=0||void 0===arguments[0]?this.locale:arguments[0],t=this,n=arguments.length<=1||void 0===arguments[1]?"":arguments[1],r=arguments[2],i=this[H.normalise](n,e),o=this[H.splitOnPlaceholders](i),s={},a=0,c=o.map(function(e){if(e.startsWith("[")){var n=e.substr(1).replace(new RegExp("\\]$","u"),"");return s[n]=a,a++,r[n]}return" "===e?"\\b \\b":t[H.escape](e).replace(new RegExp("^ ","u"),"\\b").replace(new RegExp(" $","u"),"\\b")}),l=new RegExp(`^${c.join("")}$`,"iu");return{regexp:l,placeholders:s,match:n}},e.prototype[H.splitOnPlaceholders]=function(e){var t=[""],n=0;return e.split("").forEach(function(e){"["===e&&""!==t[n]&&(n++,t[n]=""),t[n]+=e,"]"===e&&(n++,t[n]="")}),t},e.prototype[H.escape]=function(e){return e.replace(new RegExp("\\.","gu"),"\\.").replace(new RegExp("\\/","gu"),"\\/").replace(new RegExp("\\(","gu"),"\\(").replace(new RegExp("\\)","gu"),"\\)")},e}(),q=Object.freeze({wakewordRecogniser:Symbol("wakewordRecogniser"),wakewordModelUrl:Symbol("wakewordModelUrl"),speechRecogniser:Symbol("speechRecogniser"),speechSynthesis:Symbol("speechSynthesis"),idle:Symbol("idle"),initialiseSpeechRecognition:Symbol("initialiseSpeechRecognition"),startListeningForWakeword:Symbol("startListeningForWakeword"),stopListeningForWakeword:Symbol("stopListeningForWakeword"),listenForUtterance:Symbol("listenForUtterance"),handleSpeechRecognitionEnd:Symbol("handleSpeechRecognitionEnd"),intentParser:Symbol("intentParser")}),$=["wakelistenstart","wakelistenstop","wakeheard","speechrecognitionstart","speechrecognitionstop","reminder"],K=function(e){function t(){u(this,t);var n=f(this,e.call(this,$));return n[q.idle]=!0,n[q.wakewordModelUrl]="data/wakeword_model.json",n[q.speechRecogniser]=new N,n[q.speechSynthesis]=new F,n[q.wakewordRecogniser]=new P,n[q.intentParser]=new J,n[q.wakewordRecogniser].setOnKeywordSpottedCallback(function(){n.emit($[2],{type:$[2]}),n.startSpeechRecognition()}),Object.seal(n),n}return p(t,e),t.prototype.start=function(){return this[q.initialiseSpeechRecognition]().then(this[q.startListeningForWakeword].bind(this))},t.prototype.startSpeechRecognition=function(){var e=this;return this[q.idle]=!1,this[q.stopListeningForWakeword]().then(this[q.listenForUtterance].bind(this)).then(this[q.handleSpeechRecognitionEnd].bind(this)).then(this[q.startListeningForWakeword].bind(this)).catch(function(t){console.log("startSpeechRecognition err",t),e.emit($[4],{type:$[4]}),e[q.startListeningForWakeword]()})},t.prototype.stopSpeechRecognition=function(){return this[q.speechRecogniser].abort().then(this[q.startListeningForWakeword].bind(this))},t.prototype.speak=function(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0];this[q.speechSynthesis].speak(e)},t.prototype[q.initialiseSpeechRecognition]=function(){var e=this;return fetch(this[q.wakewordModelUrl]).then(function(e){return e.json()}).then(function(t){e[q.wakewordRecogniser].loadModel(t)})},t.prototype[q.startListeningForWakeword]=function(){return this.emit($[0],{type:$[0]}),this[q.idle]=!0,this[q.wakewordRecogniser].startListening()},t.prototype[q.stopListeningForWakeword]=function(){return this.emit($[1],{type:$[1]}),this[q.wakewordRecogniser].stopListening()},t.prototype[q.listenForUtterance]=function(){return this.emit($[3],{type:$[3]}),this[q.speechRecogniser].listenForUtterance()},t.prototype[q.handleSpeechRecognitionEnd]=function(e){var t=this;this.emit($[4],{type:$[4],result:e}),this[q.intentParser].parse(e.utterance).then(function(e){t.emit($[5],{type:$[5],result:e})}).catch(function(t){console.error("Error while parsing the sentence:",t),console.error("Sentence was:",e.utterance)})},h(t,[{key:"idle",get:function(){return this[q.idle]}}]),t}(T),Z="cue-",Q="https://calendar.knilxof.org",X=1,ee=/([A-Z])/g,te=Object.freeze({values:Symbol("values"),storage:Symbol("storage"),updateSetting:Symbol("updateSetting"),stringToSettingTypedValue:Symbol("stringToSettingTypedValue"),getDefaultSettingValue:Symbol("getDefaultSettingValue"),onStorage:Symbol("onStorage")}),ne=Object.freeze({SESSION:Object.freeze({key:"session"})}),re=function(e){function t(){var n=arguments.length<=0||void 0===arguments[0]?localStorage:arguments[0];u(this,t);var r=f(this,e.call(this));return r[te.storage]=n||{getItem:function(){return null},setItem:function(){},removeItem:function(){},clear:function(){}},r[te.values]=new Map,Object.keys(ne).forEach(function(e){var t=ne[e],n=r[te.storage].getItem(`${Z}${t.key}`);r[te.values].set(t,r[te.stringToSettingTypedValue](t,n))}),window.addEventListener("storage",r[te.onStorage].bind(r)),Object.seal(r),r}return p(t,e),t.prototype.clear=function(){var e=this;return new Promise(function(t){Object.keys(ne).forEach(function(t){var n=ne[t];e[te.updateSetting](n,e[te.getDefaultSettingValue](n))}),t()})},t.prototype[te.updateSetting]=function(e,t){var n=this[te.values].get(e);n!==t&&(this[te.values].set(e,t),t!==this[te.getDefaultSettingValue](e)?this[te.storage].setItem(`${Z}${e.key}`,t):this[te.storage].removeItem(`${Z}${e.key}`),this.emit(e.key.replace(ee,function(e){return`-${e.toLowerCase()}`}),t))},t.prototype[te.stringToSettingTypedValue]=function(e,t){return null===t?this[te.getDefaultSettingValue](e):"boolean"===e.type?"true"===t:"number"===e.type?Number(t):t},t.prototype[te.getDefaultSettingValue]=function(e){return void 0!==e.defaultValue?e.defaultValue:"boolean"!==e.type&&("number"===e.type?0:null)},t.prototype[te.onStorage]=function(e){if(e.key.startsWith(Z)){var t=e.key.substring(Z.length),n=Object.keys(ne).find(function(e){return ne[e].key===t});if(!n)return void console.warn(`Changed unknown storage entry with app specific prefix: ${e.key}`);var r=ne[n];this[te.updateSetting](r,this[te.stringToSettingTypedValue](r,e.newValue))}},h(t,[{key:"session",get:function(){return this[te.values].get(ne.SESSION)},set:function(e){this[te.updateSetting](ne.SESSION,e)}},{key:"origin",get:function(){return Q}},{key:"apiVersion",get:function(){return X}}]),t}(T);c.prototype=Object.create(Error.prototype);var ie=Object.freeze({settings:Symbol("settings"),online:Symbol("online"),init:Symbol("init"),fetch:Symbol("fetch")}),oe=function(e){function t(n){u(this,t);var r=f(this,e.call(this,["online"]));return r[ie.settings]=n,r[ie.online]=!1,Object.seal(r),r[ie.init](),r}return p(t,e),t.prototype[ie.init]=function(){var e=this;this[ie.online]=navigator.onLine,window.addEventListener("online",function(t){e[ie.online]=t,e.emit("online",t)}),window.addEventListener("offline",function(t){e[ie.online]=t,e.emit("online",t)}),"connection"in navigator&&"onchange"in navigator.connection&&navigator.connection.addEventListener("change",function(){var t=navigator.onLine;e[ie.online]=t,e.emit("online",t)})},t.prototype.fetchJSON=function(e){var t=arguments.length<=1||void 0===arguments[1]?"GET":arguments[1],n=arguments.length<=2||void 0===arguments[2]?void 0:arguments[2],r="application/json";return this[ie.fetch](e,r,t,n).then(function(e){var t=e.headers.get("Content-Type")||"";if(!e.ok||t.startsWith(r))return e.json()})},t.prototype.fetchBlob=function(e,t,n,r){return this[ie.fetch](e,t,n,r).then(function(e){return e.blob()})},t.prototype[ie.fetch]=function(e,t){var n=arguments.length<=2||void 0===arguments[2]?"GET":arguments[2],r=arguments.length<=3||void 0===arguments[3]?void 0:arguments[3];n=n.toUpperCase();var i={method:n,headers:{Accept:t},cache:"no-store"};return this[ie.settings].session&&(i.headers.Authorization=`Bearer ${this[ie.settings].session}`),void 0!==r&&(i.headers["Content-Type"]="application/json;charset=UTF-8",i.body=JSON.stringify(r)),fetch(e,i).then(function(e){if(!e.ok)throw new c(e.status);return e})},h(t,[{key:"origin",get:function(){return this[ie.settings].origin}},{key:"online",get:function(){return this[ie.online]}}]),t}(T),se=Object.freeze({api:Symbol("api"),settings:Symbol("settings"),listenForMessages:Symbol("listenForMessages")}),ae=function(e){function t(n,r){u(this,t);var i=f(this,e.call(this,["message"]));return i[se.api]=n,i[se.settings]=r,Object.seal(i),i}return p(t,e),t.prototype.subscribeToNotifications=function(){var e=this;return navigator.serviceWorker?(navigator.serviceWorker.addEventListener("message",this[se.listenForMessages].bind(this)),navigator.serviceWorker.ready.then(function(e){return e.pushManager.getSubscription().then(function(t){return t||e.pushManager.subscribe({userVisibleOnly:!0})})}).then(function(t){return e[se.api].post("subscriptions",{subscription:t,title:`Browser ${navigator.userAgent}`})}).catch(function(e){if("denied"===Notification.permission)throw new Error("Permission request was denied.");if(!(e instanceof c&&409===e.statusCode))throw new Error(`There was an error while subscribing to push notifications: ${e}`)})):Promise.reject("No service worker supported")},t.prototype[se.listenForMessages]=function(e){return e.data?void this.emit("message",e.data):void console.error("Received a push message without a payload.")},t}(T),ce=Object.freeze({settings:Symbol("settings"),net:Symbol("net"),getURL:Symbol("getURL"),onceOnline:Symbol("onceOnline"),onceReady:Symbol("onceReady"),getChannelValues:Symbol("getChannelValues"),updateChannelValue:Symbol("updateChannelValue")}),le=function(){function e(t,n){u(this,e),this[ce.net]=t,this[ce.settings]=n,Object.freeze(this)}return e.prototype.get=function(e){var t=this;return this[ce.onceReady]().then(function(){return t[ce.net].fetchJSON(t[ce.getURL](e))})},e.prototype.post=function(e,t){var n=this;return this[ce.onceReady]().then(function(){return n[ce.net].fetchJSON(n[ce.getURL](e),"POST",t)})},e.prototype.put=function(e,t){var n=this;return this[ce.onceReady]().then(function(){return n[ce.net].fetchJSON(n[ce.getURL](e),"PUT",t)})},e.prototype.delete=function(e,t){var n=this;return this[ce.onceReady]().then(function(){return n[ce.net].fetchJSON(n[ce.getURL](e),"DELETE",t)})},e.prototype.blob=function(e,t){var n=this,r=arguments.length<=2||void 0===arguments[2]?"image/jpeg":arguments[2];return this[ce.onceReady]().then(function(){return t?n[ce.net].fetchBlob(n[ce.getURL](e),r,"PUT",t):n[ce.net].fetchBlob(n[ce.getURL](e),r);
})},e.prototype[ce.getURL]=function(e){if(!e||"string"!=typeof e)throw new Error("Path should be a valid non-empty string.");return`${this[ce.net].origin}/api/v${this[ce.settings].apiVersion}/${e}`},e.prototype[ce.onceReady]=function(){return Promise.all([this[ce.onceOnline]()])},e.prototype[ce.onceOnline]=function(){var e=this[ce.net];return e.online?Promise.resolve():new Promise(function(t){return e.once("online",function(){return t()})})},e}(),ue=Object.freeze({api:Symbol("api"),settings:Symbol("settings")}),he=function(){function e(t,n){u(this,e),this[ue.api]=t,this[ue.settings]=n,Object.seal(this)}return e.prototype.getAll=function(){return this[ue.api].get("reminders")},e.prototype.get=function(e){return this[ue.api].get(`reminders/${e}`)},e.prototype.set=function(e){return this[ue.api].post(`reminders`,e)},e.prototype.delete=function(e){return this[ue.api].delete(`reminders/${e}`)},e}(),pe=Object.freeze({settings:Symbol("settings"),net:Symbol("net"),webPush:Symbol("webPush"),api:Symbol("api")}),fe=function(e){function t(){var n=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],r=n.settings,i=n.net;u(this,t);var o=f(this,e.call(this,["login","online","push-message"]));return o[pe.settings]=r||new re,o[pe.net]=i||new oe(o[pe.settings]),o[pe.api]=new le(o[pe.net],o[pe.settings]),o[pe.webPush]=new ae(o[pe.api],o[pe.settings]),o.reminders=new he(o[pe.api],o[pe.settings]),o[pe.net].on("online",function(e){return o.emit("online",e)}),o[pe.webPush].on("message",function(e){return o.emit("push-message",e)}),window.server=o,Object.seal(o),o}return p(t,e),t.prototype.clear=function(){var e=arguments.length<=0||void 0===arguments[0]||arguments[0],t=[this[pe.settings].clear()];return navigator.serviceWorker||e||t.push(navigator.serviceWorker.ready.then(function(e){return e.unregister()})),Promise.all(t)},t.prototype.login=function(e,t){var n=this;return this[pe.api].post("login",{user:e,password:t}).then(function(e){n[pe.settings].session=e.token,n.emit("login")})},t.prototype.logout=function(){return this[pe.settings].session=null,Promise.resolve()},t.prototype.subscribeToNotifications=function(){return this.isLoggedIn?this[pe.webPush].subscribeToNotifications():Promise.reject(new Error("Error while subscribing to push notifications: user is not logged in"))},h(t,[{key:"online",get:function(){return this[pe.net].online}},{key:"isLoggedIn",get:function(){return!!this[pe.settings].session}}]),t}(T),de=Object.freeze({controllers:Symbol("controllers"),speechController:Symbol("speechController"),server:Symbol("server"),subscribeToNotifications:Symbol("subscribeToNotifications"),onHashChanged:Symbol("onHashChanged")}),ge=function(e){function t(){u(this,t);var n=f(this,e.call(this)),r=document.querySelector(".app-view-container"),i=new K,o=new fe,s={mountNode:r,speechController:i,server:o},a=new b(s),c=new R(s);return n[de.controllers]={"":a,"users/(.+)":a,reminders:c},n[de.speechController]=i,n[de.server]=o,window.addEventListener("hashchange",n[de.onHashChanged].bind(n)),n}return p(t,e),t.prototype.main=function(){var e=this;screen&&"orientation"in screen&&"lock"in screen.orientation&&screen.orientation.lock("landscape").catch(function(e){console.error(e)}),this[de.speechController].start().then(function(){console.log("Speech controller started")}),this[de.server].on("login",function(){return e[de.subscribeToNotifications]()}),this[de.server].on("push-message",function(t){e[de.speechController].speak(`${t.title}: ${t.body}`)}),location.hash="",setTimeout(function(){e[de.server].isLoggedIn?(e[de.subscribeToNotifications](),location.hash="reminders"):location.hash="users/login"})},t.prototype[de.onHashChanged]=function(){var e=window.location.hash.slice(1);for(var t of Object.keys(this[de.controllers])){var n=e.match(new RegExp(`^${t}$`));if(n){var r;(r=this[de.controllers][t]).main.apply(r,d(n.slice(1)));break}}},t.prototype[de.subscribeToNotifications]=function(){this[de.server].subscribeToNotifications().catch(function(e){console.error("Error while subscribing to notifications:",e)})},t}(g),me=new ge;me.main()});
//# sourceMappingURL=app.js.map
